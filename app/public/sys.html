<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible"
    content="ie=edge">
  <title>系统监控平台</title>
  <link rel="stylesheet"
    href="http://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <link rel="stylesheet"
    href="./css/sys.css">
</head>

<body>
  <h4>系统在线人员统计</h4>
  <div id="app"
    class="app_hide">
    <el-card class="mt20"
      v-for="(clients, key) in roomClients"
      :key="key">
      <div slot="header"
        class="clearfix">
        <span>{{key}}</span>
      </div>
      <template v-for="(client, index) in clients">
        <el-tooltip :key="client.clientId"
          placement="top"
          effect="light">
          <div slot="content">
            用户： {{client.userId}}
            <br>
            连接时间： {{client.connectTimeShow}}
            <br>
            活跃时间： {{client.lastLiveTimeShow}}
          </div>
          <el-tag :class="{ml10: index !== 0}">{{client.username}} - {{client.version}}</el-tag>
        </el-tooltip>
      </template>
    </el-card>
  </div>
  <script src="./lib/jquery/3.4.1/jquery.min.js"></script>
  <script src="./lib/socket.io/2.3.0/socket.io.js"></script>
  <script src="http://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="http://unpkg.com/element-ui/lib/index.js"></script>
  <script src="https://cdn.bootcss.com/moment.js/2.24.0/moment.min.js"></script>
  <script src="http://cdn.bootcss.com/moment.js/2.24.0/locale/zh-cn.js"></script>
  <!-- <script src="http://cdn.bootcss.com/echarts/4.1.0/echarts.min.js"></script> -->
  <script>
    Vue.prototype.$ELEMENT = { size: 'mini', zIndex: 3000 };
    var app = new Vue({
      el: '#app',
      data: {
        reload: false,
        rooms: [],
        roomClients: {},
        paddingTime: 0
      },
      created() {
        const socket = io('/sys', {
          // 实际使用中可以在这里传递参数
          query: {
            room: 'center',
            userId: `csj-center-egg_client_${Math.random()}`,
            username: 'csj-center-egg'
          },
          transports: ['websocket']
        });
        socket.on('user all online', msg => {
          const { clients, meta } = msg
          this.paddingTime = Date.now() - meta.timestamp
          console.log('user all online', clients)
          let temp = new Set()
          let roomClients = {}
          clients.forEach(v => {
            v.connectTimeShow = this.fromNow(v.connectTime)
            v.lastLiveTimeShow = this.fromNow(v.lastLiveTime)
            temp.add(v.room)
            roomClients[v.room] = roomClients[v.room] || []
            roomClients[v.room].push(v)
          })
          this.rooms = [...temp]
          this.roomClients = roomClients
        });
        socket.on('user room online', msg => {
          console.log('user room online', msg)
          const { room, clients, client, action } = msg
          if (action === 'join') {
            if (!this.roomClients[room]) {
              this.$set(this.roomClients, room, [])
            }
            client.connectTimeShow = this.fromNow(client.connectTime)
            client.lastLiveTimeShow = this.fromNow(client.lastLiveTime)
            this.roomClients[room].unshift(client)
          } else {
            this.roomClients[room].splice(this.roomClients[room].findIndex(v => v.clientId === client.clientId), 1)
            if (this.roomClients[room].length === 0) {
              delete this.roomClients[room]
              this.roomClients = { ...this.roomClients }
            }
          }
        })
        socket.on('on living', client => {
          console.log('on living', client)
          const { room, clientId } = client
          client.connectTimeShow = this.fromNow(client.connectTime)
          client.lastLiveTimeShow = this.fromNow(client.lastLiveTime)
          this.roomClients[room].splice(this.roomClients[room].findIndex(v => v.clientId === clientId), 1)
          this.roomClients[room].unshift(client)
        })
      },
      mounted() {
        this.reload = true
        $('#app').removeClass('app_hide')
        setInterval(() => {
          for (let room in this.roomClients) {
            this.roomClients[room].forEach(v => {
              v.connectTimeShow = this.fromNow(v.connectTime)
              v.lastLiveTimeShow = this.fromNow(v.lastLiveTime)
            })
          }
        }, 3000)
      },
      methods: {
        moment,
        fromNow(time) {
          let res = (new Date(time)).getTime() + this.paddingTime
          return this.moment(res).fromNow()
        }
      }
    })
  </script>
</body>

</html>